<script>
    /**
     * Manager for heading links.
     */
    class HeadingLinksManager {
        private static readonly HEADING_SELECTOR = '.mdx-content h1, .mdx-content h2, .mdx-content h3, .mdx-content h4';
        private static readonly ID_REGEX = /[^a-z0-9]+/g;
        private static readonly TRIM_REGEX = /(^-|-$)/g;

        private usedIds: Map<string, number> = new Map(); // map to track used IDs and their counts

        /**
         * Smoothly scroll to the target element.
         * @param targetId - ID of the target element to scroll to.
         */
        private smoothScrollTo(targetId: string): void {
            const targetElement = document.getElementById(targetId);

            if (targetElement) {
                window.scrollTo({
                    top: targetElement.offsetTop,
                    behavior: 'smooth'
                });
            }
        }

        /**
         * Generate a heading ID.
         * @param text - Text to generate an ID from.
         * @returns Heading ID.
         */
        private generateHeadingId(text: string | null): string | null {
            if (!text) return null;

            // Generate the base ID.
            const baseId = text.toLowerCase().replace(HeadingLinksManager.ID_REGEX, '-').replace(HeadingLinksManager.TRIM_REGEX, '');

            // If this is the first occurrence, use the base ID.
            if (!this.usedIds.has(baseId)) {
                this.usedIds.set(baseId, 1);
                return baseId;
            }

            // For subsequent occurrences, append a number.
            const count = this.usedIds.get(baseId)! + 1;
            this.usedIds.set(baseId, count);
            return `${baseId}-${count}`;
        }

        /**
         * Create an anchor element.
         * @param id - ID to link to.
         * @returns Anchor element.
         */
        private createAnchorElement(id: string): HTMLAnchorElement {
            const anchor = document.createElement('a');

            anchor.className = 'anchor absolute left-1 px-2 rounded-full border-none hover:bg-link dark:hover:bg-link-dark font-source text-[10pt] hover:text-bg dark:hover:text-bg-dark';
            anchor.href = `#${id}`;
            anchor.innerHTML = '#';
            anchor.setAttribute('aria-hidden', 'true');

            return anchor;
        }

        /**
         * Handle an anchor click.
         * @param e - Mouse event.
         * @param id - ID to link to.
         */
        private handleAnchorClick(e: MouseEvent, id: string): void {
            e.preventDefault();

            const url = `${window.location.origin}${window.location.pathname}#${id}`;
            this.smoothScrollTo(id);
            window.history.pushState({}, '', url);

            navigator.clipboard.writeText(url).catch((error) => {
                console.error('Failed to copy URL:', error);
            });
        }

        /**
         * Add heading links to all headings.
         */
        public addHeadingLinks(): void {
            // Reset the used IDs map for each new page.
            this.usedIds = new Map();

            const headings = document.querySelectorAll<HTMLHeadingElement>(HeadingLinksManager.HEADING_SELECTOR);
            headings.forEach((heading) => {
                const id = this.generateHeadingId(heading.textContent);

                if (!id) return; // skip headings without text

                const anchor = this.createAnchorElement(id);

                anchor.addEventListener('click', (e) => this.handleAnchorClick(e, id));

                heading.insertAdjacentElement('afterbegin', anchor);
                heading.id = id;
            });
        }

        /**
         * Refresh the heading links.
         */
        public refresh() {
            console.log('[doc] Refreshing heading links...');

            manager.addHeadingLinks();
            const headings = manager.collectHeadings();
            document.dispatchEvent(new CustomEvent('headingsCollected', { detail: headings }));

            console.log(`[doc] refreshed ${headings.length} heading links`);
        }
    }

    const manager = new HeadingLinksManager();

    manager.addHeadingLinks(); // run on initial page load

    // Re-run when navigating between pages (for View Transitions).
    document.addEventListener('astro:page-load', () => {
        manager.addHeadingLinks();
    });
    manager.refresh();
    document.addEventListener('astro:page-load', manager.refresh);
</script>
